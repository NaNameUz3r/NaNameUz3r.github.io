---
title: "Обзор DNS"
tags: "Сеть"
lang: ru
show_edit_on_github: false
comment: true
license: false
modify_date: "2022-06-01"
show_subscribe: false
article_header:
  theme: dark
  type: overlay
  align: left
  background_image:
    src: /header_images/dns.jpg
---

Краткий обзор на DNS или как дозвониться в библиотеку, бабуля?

<!--more--> 

И Артпанет и наш нынешний интернет на очень примитивном уровне и грубо говоря — телефонна сеть. У каждого участника этой сети есть свой "номер телефона" — IPv4 или IPv6 адрес, по которому к нему можно "дозвониться", например на какой нибудь порт. 

на заре интернета в роли DNS выступал текстовый файлик HOSTS.TXT, который хранился в некотором сетевом информационно центре, и чтобы получить нужный адрес или внести свой в этот центр **нужно было... звонить!**  Чем больше развивалась сеть, тем больше становилось хостов, и поддерживать HOSTS.TXT стало, мягко говоря, неудобно. Тут родился DNS.

# Что такое DNS 

Domain Name System — это такая распределенная система, которая "превращает" доменные имена в IP адреса, которые клиент использует для получения нужных ему ресурсов с целевого сервера. Ну там, страничку в браузере загрузить :)

Служит вся эта история в первую очередь для нашего человеческого удобства.

# DNS сервер

Грубо говоря, DNS сервер это такой сервер, который хранит у себя подобие записной книги контактов в вашем телефоне — своего рода база данны, в которой записаны публичные IP адреса и связанные с ними *доменные имена*.

Как только IP адрес найден и передан клиенту, этот самый клиент может устанавливать нужные ему соединения, например с ближайшим CDN (content delivery network) сервером, на котором закеширован искомый ресурс или с "исходным", как говорится origin сервером.

# Как устроен DNS 

В обычным DNS запросе URL адрес, введенный пользователем должен пройти через четыре сервера, чтобы получить клиент получил нужный адрес. 

Все эти четыре сервера работают вместе таким образом:

- DNS Recursor: его ещё называют "преобразователем DNS". Этот сервер получает DNS запрос от клиента, а потом связывается с другими DNS сервера, чтобы они помогли ему найти верный адрес. На этом этапе преобразователь сам действует как клиент — он создает один или несколько DNS запросов, которые отправляются дальше.

- Root nameservers: это *коренные серверы имен*. Коревой сервер назначен на определенную *корневую* DNS зону интернета. Задачей такого сервера является обработка полученных DNS запросов, отвечая на которые корневой сервер формирует список *Авторитетных серверов имен **верхнего уровня (TLD)***, которые *вероятно могут* знать искомый в запросе адрес.

    Уровень домена определяется количеством точек в доменном имени. например blablabla.com будет доменом верхнего уровня, тогда как blabla.killme.com — второго, и так далее.


- TLD nameservers: или Top Level Domain Nameservers связаны с доменами верхнего уровня, и обычно эти серверы идут после коренных. Для простоты их можно представлять как ответвления от коренных серверов. На них содержится информация о доменах следующего уровня *конкретных DNS зон*.

- Authoritative nameservers: это те сервера, которые уже наконец дают какой то реальный ответ на изначальный DNS запрос. Есть два ипа таких серверов: главный сервер, и вторчный. Главный хранит *исходные* копие записей своей зоны, а вторичный (один или несколько) являются репликами главного, которые служат для распределния нагрузки и страховым вариантом в случае сбоя главнго сервера. Эти сервера так же хранят ресурсные DNS записи (А, АААА, CNAME, MX, TXT, и так далее)

# Кэширование DNS

Кэширование результатов DNS запросов может происходить на уровне операционной системы или браузера. Это необходимо для оптимизации, ускорения обработки запросов. Зачем искать адрес, который мы итак уже знаем?

## Рекурсивные сервера

Мы уже выяснили, что авторитативные серверы хранят настоящие DNS записи, тогда как *рекурсивные* серверы выступают в роли посредников, которые находятся между авторитативным сервером и конечным клиентом. Чтобы найти нужную запись (нужный сервер имен) рекурсивные серверы посредством DNS запросов "рекурсивно" проходят по дереву DNS серверов, чтобы наконец добраться до своей цели.

Рекурсивные серверы хранят у себя в кеше результаты своих "путешествий", чтобы каждый раз не искать по новой. Время такого кеширования определяется хозяином домена с помощью параметра TTL (time to live). 

# Ещё раз... как как это работает?

Если всё ещё непонятно, давайте быстро разберем базовый случай. 

1. Вбиваем адрес сайта в браузер.
2. Браузер проверяет кэш. Если адреса есть — начинает работать с ресурсом используя этот адрес. Если адреса нет идем дальше.
3. Бразуер отправляет запрос к DNS-резолверу. Резолвер это такая служба в операционной сети. Если в кэше у резолвера нашелся нужный адрес — возвращаем его браузеру для работы, если адреса нет:
4. DNS-резолвер отправляет запрос DNS-резолверу вашего интернет провайдера, или резолверу Google (8.8.8.8, 4.4.4.4), или на худой конец в CloudFlare (1.1.1.1). Резолвер снова проверяет свой кэш на предмет запроса. Если и тут адреса нет:
5. DNS-резолвер провайдера отправляет запросы коренным DNS серверам (кому слать резолвер понимает по домену верхнего уровня). Корневые серверы проверяют есть ли у них информация о домене верхнего уровня из полученного запроса. Если такая информация найдена, коренной сервер возвращает резолверу адрес TLD сервера. Если нет — возвращает ошибку, потому что запрощенной зоны просто не существует.
6. Резовер, получив адрес TLD сервера отправляет к нему запрос, и TLD сервер проверяет у себя информацию о домене второго уровня из запроса. Если такой домен у него есть, значит домен существует и зарегистрирован. Тогда TLD сервер вернет адрес авторитативного сервера.
7. Получив адрес авторитативного сервера резолвер отправляет ему запрос. Авторитативный сервер проверяет свою базу данных, и если нужный домен в ней есть — возвращает его IP адресс, который записан в А записи этого домена.
8. Наконец, когда нужный адрес найдер и получен резолвером, последний записывает этот адрес в свой кэш и передает его в резовер нашей операционной системы, который оттуда попадает в браузер (и оседает в кэш соответственно).

Всё это работает быстро, в первую очередь благодаря кэшированию на многих уровнях DNS системы.

# Дайте потрогать!

Посмотреть глазами как это работает можно с помощью утилиты dig, которая есть и на линуксе и на, простите, макоси. Если вы заядный виндузятник можете воспользоваться NSLOOKUP, но лучше поставьте Linux :D

Трейснуть dns с помощью dig можно командой:

        gid +trace <интересующий_домен>

Если dig у вас по какой то причине не установлен, нужно установить dnsutils или bind-utils для debian и redhat семейств соответственно.

Если вы всё таки решили сидеть на винде, и читаете это до сих пор, а NSLOOKUP вдруг неожиданно оказался не очень информативной штукой, вы можете воспользоваться любым онлайн инструментов для трейса DNS. 

# Резюме

Как видите в DNS ничего страшного и сложного нет, и работает эта штука предельно понятно. Я не говорю тут про имплементацию самих серверов, это наверное совсем отдельная тема :D

По традиции для владеющих английским языком, и жадных до знаний приведу для затравки пару RFC по теме: [RFC 1035](https://datatracker.ietf.org/doc/html/rfc1035) с основой спецификацией, и [RFC 1912](https://datatracker.ietf.org/doc/html/rfc1912) уже на тему "Common DNS Operational and Configuration Errors".

