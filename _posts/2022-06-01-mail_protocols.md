---
title: "Почтовые протоколы"
tags: "Сеть"
lang: ru
show_edit_on_github: false
comment: true
license: false
modify_date: "2022-06-01"
show_subscribe: false
article_header:
  theme: dark
  type: overlay
  align: left
  background_image:
    src: /header_images/http.jpg
---

Немного о том как письма в интернете ходят.

<!--more--> 

Привет! В этому посте я предлагаю немного ознакомиться с почтовыми протоколами. Какие бывают? Попробуем понять чем они отличаются. В нашем прицеле сегодня POP3, SMTP, ESMTP и IMAP.

# POP3
Протокл POP3 (Post Office Protocol) — это ещё один ~~старый~~ стандартный сетевой протокол используемый локальными почтовыми клиентами для получения писем с почтового сервера по TCP/IP соединению. Первая версия протола появилась в 1984 году ([RFC 918](https://datatracker.ietf.org/doc/html/rfc918)), а актуальная версия, как не сложно догадаться — третья!

Кому интересно: Вторая версия протокола описана в [RFC 937](https://datatracker.ietf.org/doc/html/rfc937) в 85 году, третья в [RFC 1081](https://datatracker.ietf.org/doc/html/rfc1081) в 1988. В течении следующих 10 лет протокол несколько раз прееопредялялся, и последняя актуальная версия была описана в 1996 году в [RFC 1939](https://www.ietf.org/rfc/rfc1939.txt).

Протокол до сих пор очень распространен, и одной из главных причин этому — простота его конфигурации. 

## Как работает POP3
Серверы электронной почты, размещенные например у интернет провайдеров, так же часто используют POP3 для получения и харнения писем, предназначенных для их подписчиков. Периодически эти самые подписчики используют клиенты для проверки своих ящиков на удаленных почтовых серверах, и загружают письма предназначенные им. 

Обычно, когда письмо загруженно клиентом, оно удаляется с почтового сервера. Некоторые почтовые клиенты позволяют менять это поведения, копируя письмо на локальный хост и не удаляя его с сервера в течении определенного времени. 

Как правило клиенты используют 110 порт для подключения к POP3 серверу. Существует так же версия поддерижвающая шифрование — POP3S. Работает с TLS или SSL обычно на порту 995.

Преимущества POP3:
- Так как почта загружается на компьютер пользователя её можно читать в оффлайне;
- Аттачменты можно открывать быстро, по той же причине — они уже скачаны;
- Нужно меньше дискового пространства на сервере, так как письма хранятся у клиента;
- Широко распространен, легко настроить.

Минусы:
- Если почты много пользователю может потребоваться выделять для её хранения слишком много дискового пространства;
- Всю почту можно утратить если медным тазом накроется диск, или ещё хуже — если в почте были конфиденциальные данные и ваш компьютер украли...
- Нет настроек сортировки писем, вся почта летит в одну директорию;
- Если в используемом клиенте нет возможности копировать письмо с сервера (только выкачивать с удалением), то приедтся пользоваться почтой только с одного устройства;
- Письма можно скачивать только целиком, вместе с аттачами.

# IMAP

Inernet Message Access Protocol — ещё один почтовый протокол для получения писем с почтового сервера. Аналог POP. Точно так же работает в клиент-серверной архитектуре. Всё поверх того же TCP/IP, используя по дефолту 143 порт для незащищенного соединения, и 993 для шифрованного.

Первая версия задокументирована в [RFC 1064](https://datatracker.ietf.org/doc/html/rfc1064) в июле 1988, обновлена в [RFC 1176](https://datatracker.ietf.org/doc/html/rfc1176) в августе 1990, IMAP3 появился в феврале 1991, описан в [RFC 1203](https://datatracker.ietf.org/doc/html/rfc1203).

IMAP3, кстати, никто так и не использовал, все продолжали работать с IMAP2. 

После этого было ещё одно изменение — внедрение поддержки MIME в расширении названном IMAPbis.

Наконец, современный IMAP4 впервые был описан в двух публикациях: [RFC 1730](https://datatracker.ietf.org/doc/html/rfc1730), которая содержит спецификацию протокола, и [RFC 1731](https://datatracker.ietf.org/doc/html/rfc1731) — с описанием механизма аутентификации в IMAP4.

## Фичи IMAP

Протокол был разработан специально для обеспечения максимально гибкого спобоса доступа пользователя к своему ящику. IMAP может работать в любом из трех режимов: онлайн, оффлайн или автономно (disconnected).

IMAP предоставляет следующие возможности:
- Доступ и получение почты с удаленного сервера (практически как в POP);
- Установка флага прочитанных сообщений;
- Управление несколькими почтовыми ящиками, перекидывание писем из одиного в другой, организация ящиков в категории, создавать иерархии из директорий для писем;
- Возможность загружать часть сообщения. Например без мультимедиа содержимого;
- Организация почты на сервере в соответствии с требованиями. Можно удалять или переименовывать свой ящик на сервере (в POP так нельзя);
- Можно искать письма по ключевым словам;
- Проверка заголовка письма, перед его загрузкой.

Преимущества IMAP:
- Вся почта хранится на сервере, доступна с любого устройства-клиента;
- Письма не загружаются все сразу на локальный компьютера как в POP, и соответственно нет таких требований к дисковому пространству.
- Письма хранятся в условной безопасности на сервере, риски утечек и утраты почты меньше по сравнению с POP.
- Благодаря возможности частичной загрузки почтой можно пользоваться даже при плохом соединении, загружая только тело письма без тяжелых аттачей.

Минусы IMAP:
- Вся почта на сервере, так что без интернета не получится загружать и новые и уже полученные письма, которые были кэшированы более двух недель назад;
- В случае компрометации ящика злоумышленниками всё его содержимое станет им доступно. В сравнении с POP это "палка о двух концах", но проблемы информационой безопасности корреспонденции выходят за рамки этого обзора.


# SMTP

SMTP (Simple Mail Transfer Protocol) ещё один сетевой протокол старичок, представленный в 1982 году в [RFC 821](https://datatracker.ietf.org/doc/html/rfc821).

Преследует две задачи: проверка правильности конфигурации системы, авторизация на отправку письма для конкретного устройства, и собственно сама отправка исходящего письма на указанный адрес с подтверждением успешной доставки. 

Кстати, если письмо доставить не удалось — отправитель получит алерт.

SMTP может работать практически с любыми протоколами транспортного уровня (TCP, UDP и тд). По умолчанию работет на двух портах: 25 служит для передачи почты между почтовыми серверами, и 587, по которому почта передается от клиента на сервер.
Поддерживает SSL шифрование (задействуется дополительно 465-ый порт).

## Формат письма в SMTP

Почтовое сообщение в SMTP состоит из "конверта", заголовка и тела письма. 
Формат заголовка и тела подробно описан в [RFC 2822](https://datatracker.ietf.org/doc/html/rfc2822). 

Конверт, грубо говоря, это такая абстракция для передачи сообщений между клиентом и сервером. На самом деле они общаются в привычном клиент-серверном формате запросов и ответов.

## Запросы и ответы SMTP

Самые часто используемые запросы (команды):
- Helo: служит для установки соединения, и выполняется только когда клиент укзаывает свой домен и почтовый адрес;
- Mail: задает адрес отправителя;
- RCTP: задает адрес получателя. Если получателей несколько, то они указываются каждый в отдельной RCTP команде;
- DATA: сигнал серверу о конце "конверта", после чего идет само письмо;
- QUIT: разрыв соединения после окончания письма.

Ответы SMTP состоят из кода и текста ответного сообщения. По коду можно понять если что то пошло не так. В человекочитаемом сообщении же будет указано что произошло в ходе отправки или получения письма. 

Коды начинаются с 2, 3 и 5. В первом случае всё прошло хорошо, во втором — письмо отправилось, но нужны дополнительные данные. А пятерка это алерт, что то сломалось и надо разбираться.

## Описание работы

Представим частный случай, в котором уже установлен и сконфигурирован SMTP север, и мы хотим отправить письмо:
1. Пишем письмо, указываем адрес отправителя, после чего происходит соединение с SMTP клиентом провайдера, например Gmail.
2. Происходит передача почтовых адресов отправителя и получателя, тема письма и содержимое на сервер.
3. SMTP система начинает искать SMTP сервер получателя.
4. Если целевой сервер не будет найден, наш попытается ещё несколько раз это сделать. Если все попытки проваялся мы получим алерт о том что письмо не будет доставлено.
5. Если всё хорошо и целевой сервер нашелся, то далее в работу вступают другие почтовые протоколы — POP3 или IMAP.

## Прекратить спам!

В 1995 году в качестве меры по борьбе с безудержным почтовым спамом появилось расширения SMTP протокола — ESMTP, которое добавлет дополнительные команды для защиты серверов и повышения пропускной способности. Например ESMTP привнес:

- Аутентификацию отправителя;
- SSL-шифрование почты;
- Возможность аттачить мультимедиа файлы к письмам;
- Возможность ограничить размер писем в соответствии со спецификациями сервера;
- Одновременно слать письма нескольким адресатам;
- Стандартизацию алертов о невозможности доставки.

Разумеется сейчас везде используется ESMTP, по понятным причинам.


# Резюме

Так что же выбрать, IMAP или POP? Мы вкратце рассмотрели оба протокола, и с первого взгляда кажется что IMAP намного лучше. В этом есть доля истины. В принципе, единственным серьезныем отличием является сопосб хранения писем. В POP3 мы качаем все письма себе, и *возможно* в случае каких то сверхсекретных писем можно выбрать POP3, обмазав его всевозможным шифрованием, начиная от шифрования соединения, заканчивая шифрованием диска с письмами. Но это очень спорный момент, ведь с другой стороны практически все, если не все, почтовые провайдеры поддерживают двухфакторную аутентификцаию, которую сложно обойти... Сложно же, да? :D 

Закончим на сегодня, пока я не ударился в шифропанковский параноидальный бред. Будьте здоровы!